!function(){function a(a){F=!0;try{a=Encryption.decryptMessage(a),W=!0,t(),F=!0}catch(c){var d="Malformed UTF-8 data";if(d===c.message&&!W)return void(F=!1)}try{a=JSON.parse(a)}catch(c){}a.login&&(M[0]?f(M[0],a):e(function(b){f(b,a)})),a.creditCard&&(M[0]?g(M[0],a):e(function(b){g(b,a)})),a.identity&&e(function(b){h(a)}),a.configure&&(a.configure.shortcut&&chrome.storage.sync.get("enpass_shortcut_override",function(b){b.enpass_shortcut_override?V=!0:(V=!1,chrome.storage.sync.set({enpass_shortcut:a.configure.shortcut.key}),r(a.configure.shortcut.key))}),a.configure.error&&(E=a.configure.error),a.configure.appVersion),a.fillGeneratedPassword&&b({header:"fillGeneratedPassword",generatedPassword:a.fillGeneratedPassword}),a.currentTabInfo&&e(function(b){var c={data:{tabUrl:b.url,cardUUID:a.currentTabInfo.cardUUID},type:"currentTabInfo"};0===b.url.indexOf("http")&&D.send(Encryption.encryptMessage(JSON.stringify(c)))})}function b(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(c){c[0]&&chrome.tabs.sendMessage(c[0].id,a,b)})}function c(a,b,c){chrome.tabs.sendMessage(a,b,c)}function d(a){chrome.tabs.query({},function(b){for(var c=0;c<b.length;++c)chrome.tabs.sendMessage(b[c].id,a)})}function e(a){chrome.tabs.query({currentWindow:!0,active:!0},function(b){a(b[0])})}function f(a,b){if(!b.login.tabId||a.id===b.login.tabId){var d={};d.header="enpass_loginfill",d.card=b.login;var f=b.login.domain,g=!1,h=a.url;if(f&&h&&(g=q(h,f)),b.login.url)if(g)c(a.id,d);else{if(b.login.isURLFillResponse)return;var i=function(a,e,f){if("complete"===f.status){var g=w(b.login.url);-1!==f.url.indexOf(g)&&(c(a,d),chrome.tabs.onUpdated.removeListener(i))}};"chrome://newtab/"===h||h==K?e(function(a){chrome.tabs.update(a.id,{url:b.login.url})}):chrome.tabs.create({url:b.login.url}),chrome.tabs.onUpdated.addListener(i)}else c(a.id,d),P[a.id]=B(b.login.username+b.login.password)}}function g(a,b){var d={};d.header="enpass_cardfill",d.card={ccnumber:b.creditCard.number,holderName:b.creditCard.name,cvv:b.creditCard.cvv,cardtype:b.creditCard.type,month:b.creditCard.expiry_month,year:b.creditCard.expiry_year},c(a.id,d)}function h(a){var c={};c.header="enpass_identityfill",c.card={email:a.identity.email,username:a.identity.username,fname:a.identity.fname,lname:a.identity.lname,mname:a.identity.mname,mobile:a.identity.phone,day:a.identity.day,month:a.identity.month,year:a.identity.year,state:a.identity.state,city:a.identity.city,sex:a.identity.sex,country:a.identity.country_name,zip:a.identity.zip,address:a.identity.address,company:a.identity.company,jobtitle:a.identity.jobtitle,occupation:a.identity.occupation},b(c)}function j(a){if(a){var b=0;for(var c in a)"about:blank"!==a[c].url&&b++;return b}return 0}function k(a,b){var c=a.isLogin||a.isCreditCard||a.isIdentity?!0:b.recievingFrame===b.totalFramesInCurrentTab&&b.isFurtherFrameResponseNeeded;c&&(R&&(R=!1,clearTimeout(S)),b.isFurtherFrameResponseNeeded=!1,e(function(b){delete a.header;var c={};c.data=a,c.uuid=D.uuid,c.data.tabUrl=b.url,c.type="click",D.send(Encryption.encryptMessage(JSON.stringify(c)))}))}function l(){L.isFurtherFrameResponseNeeded=!0,L.totalFramesInCurrentTab=0,L.recievingFrame=0}function m(a){F||1!==D.readyState?1!==D.readyState?chrome.windows.getCurrent({populate:!0},function(a){a.tabs.length>1?chrome.tabs.query({url:J},function(a){if(a[0]){if(H)return void chrome.tabs.update(a[0].id,{active:!0});chrome.tabs.remove(a[0].id,function(){O=null})}s()}):chrome.tabs.query({url:J},function(a){a[0]&&(H?chrome.tabs.update(a[0].id,{active:!0}):chrome.tabs.create({url:"chrome://newtab",active:!0})),s()})}):e(function(a){var c=a.url;if(0!==c.indexOf("chrome")&&0!==c.indexOf("file")&&navigator.onLine)l(),chrome.webNavigation.getAllFrames({tabId:a.id},function(a){L.totalFramesInCurrentTab=j(a)}),R=!0,S=setTimeout(function(){R=!1,L.isFurtherFrameResponseNeeded=!1,e(function(a){var b={};b.data={},b.uuid=D.uuid,b.data.tabUrl=a.url,b.type="click",D.send(Encryption.encryptMessage(JSON.stringify(b)))})},400),b({header:"guess_form"});else{var d={};d.data={},d.uuid=D.uuid,d.data.tabUrl=c,d.type="click",D.send(Encryption.encryptMessage(JSON.stringify(d)))}}):(t(),O={header:"error_page",container_header:"Upgrade Enpass App",container_description:"Your Enpass desktop application seems too old to shake hands with Browser Extension. Please update main Enpass App to latest available version.",display_btn:!1},v("data/chromeUI/enpass_error.html",O))}function n(a,b){var c=new RegExp("[\\?&]"+a+"=([^&#]*)").exec(b);if(c)return c[1]||void 0}function o(a){var b=null,c=null;b=decodeURIComponent(a);try{return c=JSON.parse(atob(b))}catch(d){return}}function p(a){var b=a.indexOf("EnpassAutoFill")-1,c=a.slice(0,b);return c}function q(a,b){if(!b)return!1;var c=b.split(",");a=w(a);for(var d=0;d<c.length;++d)if(-1!==a.indexOf(c[d]))return!0;return!1}function r(a,c){var e={};e.header="set_shortcut_for_autofill",e.shortcutKey=a?a:!1,e.isShortcutOverride=V,c?b(e):d(e)}function s(){chrome.windows.getAll({populate:!0},function(a){a.forEach(function(a){if(a.focused){var b=a.tabs.some(function(a){return a.url&&a.url===J?(E&&403===E.code?(O={header:"error_page",container_header:"Access Denied! Error 403",container_description:"Browser's code signature verification failed. Filling and other features are disabled until this configuration issue is resolved. Please E-mail the diagnostics below to us at support@enpass.io.",display_btn:!1,logs:E.logs},u(a.id,"data/chromeUI/enpass_error.html",O)):(O={header:"error_page",container_header:"Enpass Connection Error",container_description:'Please start Enpass desktop app and make sure you have checked "Enable Browser Extension" in Enpass Preferences, before using Enpass Browser Extension.',display_btn:!0},u(a.id,"data/chromeUI/enpass_error.html",O)),!0):!1});b||(E&&403===E.code?(O={header:"error_page",container_header:"Access Denied! Error 403",container_description:"Browser's code signature verification failed. Filling and other features are disabled until this configuration issue is resolved. Please E-mail the diagnostics below to us at support@enpass.io.",display_btn:!1,logs:E.logs},v("data/chromeUI/enpass_error.html",O)):(O={header:"error_page",container_header:"Enpass Connection Error",container_description:'Please start Enpass desktop app and make sure you have checked "Enable Browser Extension" in Enpass Preferences, before using Enpass Browser Extension.',display_btn:!0},v("data/chromeUI/enpass_error.html",O)))}})})}function t(){chrome.windows.getAll({populate:!0},function(a){a.forEach(function(a){a.tabs.forEach(function(a){a.url&&a.url===J&&(H?chrome.tabs.update(a.id,{url:K}):chrome.tabs.update(a.id,{url:"chrome://newtab"}))})})})}function u(a,b,d){chrome.tabs.update(a,{selected:!0},function(a){c(a.id,d)})}function v(a,b){a=chrome.extension.getURL(a),chrome.tabs.create({url:a,active:!0},function(a){c(a.id,b)})}function w(a){var b=document.createElement("a");return b.href=a,0===b.host.indexOf("www")?b.host.slice(4):b.host}function x(){H||(T=setInterval(function(){chrome.windows.getCurrent(function(a){G&&I&&!U&&setTimeout(function(){U=!0},500),a&&(a.focused&&U&&1!==D.readyState?(U=!1,E={},D.refresh()):a.focused||(U=!0))})},1e3))}function y(a){var b=chrome.runtime.getManifest(),c={type:"connected",data:{browser:"",appVersion:b.version}};H?c.data.browser="vivaldi":G?c.data.browser="opera":c.data.browser="chrome",D.send(Encryption.encryptMessage(JSON.stringify(c)))}function z(){E={},F=!1,L={totalFramesInCurrentTab:0,recievingFrame:0,isFurtherFrameResponseNeeded:!0},N={},O=null,P={},Q=!1,R=!1,S=0,T=0,U=!1,W=!1}function A(a){var b=n("EnpassAutoFill",a.url);if(b){var c=o(b),d=p(a.url);chrome.tabs.update(a.tabId,{url:d,active:!0});var e=function(a,b,d){if("complete"===d.status){M.pop(),M.push(d);var f={type:"urlFillRequested",data:{selectedCardUUID:c.autofillFromApp.selectedCardUUID,selectedCardFieldUID:c.autofillFromApp.selectedCardFieldUID}};D.send(Encryption.encryptMessage(JSON.stringify(f))),chrome.tabs.onUpdated.removeListener(e)}};chrome.tabs.onUpdated.addListener(e)}}function B(a){var b=0;if(0===a.length)return b;for(i=0;i<a.length;i++)char=a.charCodeAt(i),b=(b<<5)-b+char,b&=b;return b}var C=["ws://localhost:10391","ws://localhost:10392","ws://localhost:10393","ws://localhost:10394","ws://localhost:10395"],D=new ReconnectingWebSocket(C),E={},F=!1,G=navigator.userAgent.indexOf(" OPR/")>=0,H=navigator.userAgent.indexOf(" Vivaldi/")>=0,I=-1!==navigator.appVersion.indexOf("Linux"),J="chrome-extension://"+chrome.runtime.id+"/data/chromeUI/enpass_error.html",K="chrome-extension://"+chrome.runtime.id+"/components/startpage/startpage.html?section=Speed-dials&activeSpeedDialIndex=0",L={totalFramesInCurrentTab:0,recievingFrame:0,isFurtherFrameResponseNeeded:!0},M=[],N={},O=null,P={},Q=!1,R=!1,S=0,T=0,U=!1,V=!1,W=!1;D.debug=!1,D.timeoutInterval=1e3,D.onopen=function(){t(),y()},D.onclose=function(a){x()},D.onmessage=function(b){a(b.data)},D.onerror=function(a){z()},chrome.storage.sync.get("enpass_shortcut_override",function(a){V=a.enpass_shortcut_override?!0:!1}),chrome.storage.onChanged.addListener(function(a,b){a.enpass_shortcut_override&&"sync"===b&&(V=a.enpass_shortcut_override.newValue?!0:!1)}),chrome.runtime.onInstalled.addListener(function(a){"install"===a.reason&&(-1!==navigator.appVersion.indexOf("Mac")?chrome.storage.sync.set({enpass_shortcut:"meta+/"}):chrome.storage.sync.set({enpass_shortcut:"ctrl+/"}),chrome.storage.sync.set({enpass_shortcut_override:!1}))}),chrome.windows.onFocusChanged.addListener(function(a){1!==D.readyState&&H&&D.refresh()}),chrome.tabs.onActivated.addListener(function(a){var c={header:"setActiveTabInfo",tabId:a.tabId};b(c)}),chrome.browserAction.onClicked.addListener(function(a){M.pop(),M.push(a),m(a)}),chrome.webNavigation.onErrorOccurred.addListener(function(a){Q=!0}),chrome.webNavigation.onBeforeNavigate.addListener(function(a){Q=!1;var b=n("EnpassAutoFill",a.url);if(b){var c=o(b),d=p(a.url);chrome.tabs.update(a.tabId,{url:d,active:!0});var e=function(a,b,d){if("complete"===d.status&&c){var f={type:"urlFillRequested",data:{selectedCardUUID:c.autofillFromApp.selectedCardUUID,selectedCardFieldUID:c.autofillFromApp.selectedCardFieldUID}};M.pop(),M.push(),D.send(Encryption.encryptMessage(JSON.stringify(f))),chrome.tabs.onUpdated.removeListener(e)}};chrome.tabs.onUpdated.addListener(e)}}),chrome.contextMenus.create({id:"enpassContextMenu",title:"Enpass",contexts:["all"]}),chrome.contextMenus.onClicked.addListener(function(a,b){M.pop(),M.push(b),m(b)}),chrome.runtime.onMessage.addListener(function(a,b,d){var f={};switch(a.header){case"loginSubmitEvent":delete a.header,f={},f.data=a,chrome.tabs.query({currentWindow:!0,active:!0},function(b){var c=b[0];c.id===a.tabId&&(delete a.tabId,f.data.tabUrl=c.url,f.type="saveUpdate",f.uuid=D.uuid,P[c.id]===B(a.username+a.password)?delete P[c.id]:D.send(Encryption.encryptMessage(JSON.stringify(f))))});break;case"changePswdSubmitEvent":delete a.header,f={},f.data=a,e(function(a){f.type="updatePassword",f.data.tabUrl=a.url,f.uuid=D.uuid,D.send(Encryption.encryptMessage(JSON.stringify(f)))});break;case"guess_form_result":++L.recievingFrame,k(a,L);break;case"shortcutPressed":delete a.header,delete a.tabId,f={},f.data=a,e(function(a){M.pop(),M.push(a),f.data.tabUrl=a.url,f.type="shortcutPressed",f.uuid=D.uuid,1!==D.readyState?s():D.send(Encryption.encryptMessage(JSON.stringify(f)))});break;case"get_shortcut":chrome.storage.sync.get("enpass_shortcut",function(a){r(a.enpass_shortcut,!0)});break;case"get_error_desc":O&&c(b.tab.id,O);break;case"newShortcut":r(a.shortcut)}}),chrome.tabs.onUpdated.addListener(function(a,d,f){if("complete"===d.status){chrome.storage.sync.get("enpass_shortcut",function(a){f.id&&c(f.id,{header:"set_shortcut_for_autofill",shortcutKey:a.enpass_shortcut,isShortcutOverride:V})});e(function(a){a&&(A(a),b({header:"setActiveTabInfo",tabId:a.id}))})}})}();